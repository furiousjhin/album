"use strict";
! function () {
	function t() {
		this.variables = null, this.swf = null, this.el = "#dialogue", this.$el = null, this.pex = null, this.api = null, this.comment_list = null, this.comment_el = ".comment-container", this.story = ".story", this.btn = "_btn", this.initilized = !1, this.speed = 60, this.scene = 0, this.line = 0, this.$story = null, this.flag = !1, this.comment_deffered = null, this.motion_wait = !1, this.is_pc = null, this.width = !1, this.walking = 0
	}
	var e = window.refreshRoom || {};
	e.dialogue = e.dialogue || new t;
	var i = window.Pex;
	t.prototype.setVariables = function (t) {
		this.variables = new Object, $.extend(this.variables, t)
	}, t.prototype.setSwf = function (t) {
		if (!t) return !1;
		this.swf = t;
		var e = this;
		return this.pex = new i(this.swf, this.el.replace(/\#/g, "")), this.api = this.pex.getAPI(), this.api.ready(function () {
			e.api.destroy(), e.api = null, e.pex = null, $(e.el).empty(), e.init()
		}), !0
	}, t.prototype.startSwf = function () {
		return !!e.dialogueSwf && (this.setSwf(e.dialogueSwf), !0)
	}, t.prototype.init = function () {
		if (this.$el || (this.$el = $(this.el)), 0 == this.$el.length) return !1;
		this.initilized || (this.initCommenter(), this.initilized = !0), this.comment_deferred = $.Deferred();
		var t = this;
		return this.comment_deferred.done(function () {
			t.frameCallback()
		}), this.runPex(), !0
	}, t.prototype.initCommenter = function () {
		if (!this.initilized) {
			var t = this;
			this.setAspect(), this.comment_disp = $(this.comment_el + " > span"), this.commenter = $(this.story).comment_timer({
				click: this.story.replace(/\.|\#/g, "") + this.btn,
				speed: this.speed,
				call: function () {
					t.callback()
				}
			})
		}
	}, t.prototype.setAspect = function () {
		window.scrollTo(0, 1);
		var t = e.is_pc || window.devicePixelRatio >= 1.5 && !e.old_os ? .5 : 1,
			i = this.scaleSizeCheck() * t;
		i > 600 && $("#next").addClass("zoom-size");
		var s = i / 320,
			n = $(this.comment_el),
			o = parseInt(n.css("top")),
			a = parseInt(n.css("left")),
			r = n.css("font-size"),
			l = r.replace(/(\d+)/, ""),
			c = n.css("letter-spacing");
		n.css({
			top: o * s,
			left: a * s,
			"font-size": parseInt(r) * s + l,
			"line-height": (parseInt(r) + 3) * s + l,
			"letter-spacing": parseInt(c) * s + "px"
		})
	}, t.prototype.runPex = function () {
		var t = this;
		this.width || (this.width = this.scaleSizeCheck());
		var s = this.width,
			n = {
				enableButton: !1,
				partialDraw: window.getPexPartialDraw(),
				delayEval: !1,
				transparent: !0,
				touchEvent: !1,
				operation: {
					lighter_tgt: "lighter"
				},
				width: s,
				frameCallback: {
					"/fkds": {
						18: function () {
							t.frameCallback()
						}
					}
				}
			},
			o = $(".plate-area");
		this.clear_comment(), this.flag = !0, this.pex = new i(this.swf, this.el.replace(/\#/g, ""), n), this.api = this.pex.getAPI(), this.api.ready(function () {
			var i = $.extend({}, t.variables),
				s = window.petitManager.getCharactersKeys();
			i.unit_num = s.length;
			for (var n in s) {
				var a = e.detail[t.scene]["message_arrow_" + s[n]];
				i["position" + s[n] + "_talk"] = a;
				var r = e.detail[t.scene].message_window_type ? 2 : 1;
				i.speak_type = r, a ? o.filter("[rel=" + s[n] + "]").addClass("talking").show() : o.filter("[rel=" + s[n] + "]").removeClass("talking")
			}
			e.detail[t.scene].message_arrow_6 && (i.position6_talk = 1), t.api.setVariables("/", i)
		})
	}, t.prototype.clear_comment = function () {
		this.api && (this.api.destroy(), this.api = null, $(this.el).empty())
	}, t.prototype.setCommentList = function (t) {
		return !!t && (this.comment_list = t, !0)
	}, t.prototype.frameCallback = function () {
		this.setCommentList(e.detail[this.scene].message.split(/\n/)), this.comment_disp.eq(this.line).addClass("comment").data("comment", this.comment_list[this.line]), this.$story || (this.$story = $(this.story + this.btn)), this.flag = !1, this.$story.trigger("click")
	}, t.prototype.setMotion = function () {
		var t = e.detail[this.scene],
			i = window.petitManager.getCharactersKeys(),
			s = $(".plate-area"),
			n = this;
		for (var o in i) window.petitManager.deleteCallAction(i[o]), window.petitManager.addCallAction(i[o], function (e) {
			var i = t["motion" + e.position],
				o = 100;
			if (1 == t.id ? "out" == i ? ($("#animation_" + e.position).hide(), o = 0) : "in_walk" == i ? (e.api.setVariable("", "motion_act", "out"), e.api.callActions("", "motion_set"), o = 10, n.walking++, t.message ? n.motion_wait = !1 : n.motion_wait = !0) : s.filter("[rel=" + e.position + "]").show() : "in_walk" == i && ($("#animation_" + e.position).show(), n.walking++), !i) {
				var a = e.api.getVariable("", "motion_act");
				if (!("string" == typeof a && a.indexOf("in_walk") > -1)) return;
				i = "stay", s.filter("[rel=" + e.position + "]").show()
			}
			var r = {
				motion_act: i
			};
			setTimeout(function () {
				e.api.setVariables("", r), e.api.callActions("", "motion_set")
			}, o)
		})
	}, t.prototype.callMotion = function () {
		var t = window.petitManager.getCharactersKeys();
		for (var e in t) window.petitManager.callPetitAction(t[e])
	}, t.prototype.callback = function () {
		this.line++, this.comment_list[this.line] ? (this.comment_disp.removeClass("comment").eq(this.line).addClass("comment").data("comment", this.comment_list[this.line]), this.$story.trigger("click")) : $("#next").addClass("show-arrow")
	}, t.prototype.changeNext = function () {
		$("#next").removeClass("show-arrow"), this.motion_wait = !1, this.comment_disp.text("").removeClass("comment"), this.scene++, this.line = 0, this.walking = 0;
		var t = !1,
			i = window.petitManager.getCharactersKeys(),
			s = this.api ? this.api.getVariables("/") : {};
		for (var n in i) {
			var o = e.detail[this.scene]["message_arrow_" + i[n]] ? 1 : 0,
				a = s["position" + i[n] + "_talk"] ? 1 : 0,
				r = e.detail[this.scene].message_window_type ? 2 : 1,
				l = s.speak_type;
			if (o != a || r != l) {
				t = !0;
				break
			}
		}
		e.detail[this.scene].message_arrow_6 && setTimeout(function () {
			var t = window.refreshRoom.dialogue;
			t.setCommentList(e.detail[t.scene].message.split(/\n/)), t.comment_disp.eq(t.line).addClass("comment").data("comment", t.comment_list[t.line]), t.$story || (t.$story = $(t.story + t.btn)), t.flag = !1, t.$story.trigger("click")
		}, 300), t ? e.detail[this.scene].message ? this.init() : (this.motion_wait = !0, this.comment_list = [], this.clear_comment()) : (this.setCommentList(e.detail[this.scene].message.split(/\n/)), this.comment_disp.eq(this.line).addClass("comment").data("comment", this.comment_list[this.line]), this.$story.trigger("click")), this.setMotion(), this.callMotion()
	}, t.prototype.showAll = function () {
		for (var t in this.comment_disp) this.comment_disp.eq(t).text(this.comment_list[t]);
		this.line = this.comment_list.length
	}, t.prototype.scaleSizeCheck = function (t) {
		var e = 320;
		return t ? (this.is_pc = !0, e = this.setSize(!0)) : null === this.is_pc ? (this.is_pc = !1, e = this.setSize(!0)) : e = this.setSize(!1), e
	}, t.prototype.scaleSizeCalculate = function () {
		var t = 320;
		if (this.is_pc || window.devicePixelRatio >= 1.5 && !e.old_os) {
			var i = window.innerWidth,
				s = window.innerHeight,
				n = i / 240,
				o = s / 320,
				a = o;
			s > i && (a = n), t = 480 * a
		}
		return t
	}, t.prototype.setSize = function (t) {
		var i = this.scaleSizeCalculate(),
			s = 320;
		return 320 == i || (i >= 1280 ? (i = 1280, s = 640) : .5 * i < 320 ? (i = 640, s = 320) : s = .5 * i), t && ($("#pageContainer").css({
			width: s,
			"overflow-x": "hidden"
		}), i != s && (e.is_multiply = !0)), i
	}, window.refreshRoom = e
}(), $(function () {
	var t = window.refreshRoom,
		e = !1;
	$("#next").on("click", function (i) {
		if ("#" != $(i.currentTarget).attr("href")) return !0;
		if (e) return !1;
		if (e = !0, !t.dialogue) return e = !1, !1;
		var s = t.dialogue;
		if (t.detail[s.scene].message_arrow_6 && (s.flag = !1), !s.initilized || s.flag) return e = !1, !1;
		for (var n in s.commenter.timer) clearInterval(s.commenter.timer[n]);
		return void 0 == s.comment_list ? (e = !1, !1) : s.comment_list[s.line] ? (s.showAll(), $("#next").addClass("show-arrow"), setTimeout(function () {
			e = !1
		}, 300), !1) : t.detail[s.scene + 1] ? (s.changeNext(), setTimeout(function () {
			e = !1
		}, 300), !1) : ($(i.currentTarget).attr("href", t.returnUrl), !0)
	})
});
