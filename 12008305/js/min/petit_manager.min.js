"use strict";
! function () {
	function t() {
		var t = new Object,
			i = 640;
		this.cloth_data = new Object, this.el = "#animation-container", this.$el = null, this.prefetch = null, this.loaded_action = null, this.swf_url_list = [], this.ready_swf_list = {}, this.deleteQue = [], this.getCharacterLength = function () {
			return this.getCharactersKeys().length
		}, this.getCharactersKeys = function () {
			return Object.keys(t)
		}, this.getHasApiLength = function () {
			var e = this.getCharactersKeys(),
				i = e.length;
			for (var n in e) {
				var r = e[n];
				t[r] && !t[r].api && i--
			}
			return i
		}, this.addCharacter = function (t, e) {
			if (!e) return !1;
			if (!t) var t = this.getCharacterLength();
			$.extend({}, e);
			return this.initCharacters(), !0
		}, this.pexInitialize = function () {
			for (var e in t) {
				t[e].parent && t[e].delPex()
			}
		}, this.setCharacters = function (e, i) {
			if ("object" != typeof e) return !1;
			for (var n in e) {
				var r = $.extend({}, e[n]);
				t[n] = r
			}
			return !!i || (this.initCharacters(), !0)
		}, this.setCharactersClothes = function (e) {
			if ("object" != typeof e) return !1;
			for (var i in e)
				if (t[i]) e[i] ? t[i].image_url_list = e[i].image_url_list : this.deleteQue.push(i);
				else if (e[i]) {
				var n = $.extend({}, e[i]);
				t[i] = n
			}
		}, this.initCharacters = function () {
			this.init(t)
		}, this.initCharactersForList = function (i, n) {
			var r = {},
				a = typeof i;
			if ("string" == a) void 0 == t[i].parent && $.extend(t[i], new e(i, this)), n ? (r[i] = $.extend({}, t[i]), this.accessoryAppeal(r, i, n)) : r[i] = t[i];
			else {
				if ("array" != a) return !1;
				for (var s in i) {
					var o = i[s];
					void 0 == t[o].parent && $.extend(t[o], new e(o, this)), r[o] = t[o]
				}
			}
			this.isUsePreload(r)
		}, this.accessoryAppeal = function (e, i, n) {
			var r = {},
				a = !1,
				s = {},
				o = (this.getBodyType(i), t[i].image_url_list);
			for (var h in o)
				if (h.indexOf(n.category) > -1) {
					if (o[h].indexOf("sub_type") > -1) {
						if (o[h].indexOf("default_sub_type") > -1) continue;
						if (n.key == h) continue;
						s[n.category] = !0
					}
					a = h
				}
			$.extend(r, o), a && delete r[a], r[n.key] = n.path;
			for (var l in s) t[i].sub_type_list[l] && $.extend(r, t[i].sub_type_list[l]);
			e[i].image_url_list = r
		}, this.initCharacter = function (e) {
			return !(!e || void 0 == t[e]) && ((new Object)[e] = t[e], !0)
		}, this.deleteCharacter = function (e) {
			return void 0 != t[e] && (void 0 != t[e].api && t[e].delPex(), delete t[e], !0)
		}, this.setSwf = function (e, i) {
			return !(!e || !i) && (t[e].swf = i, !0)
		}, this.setSceneType = function (e, i) {
			return !(!e || !i) && (t[e].scene_type = i, !0)
		}, this.addCallAction = function (e, i) {
			return !(!e || !t[e] || "function" != typeof i) && (t[e].callaction = i, !0)
		}, this.deleteCallAction = function (e) {
			return !(!e || !t[e]) && (delete t[e].callaction, t[e].callaction = null, t[e].ch_variables && delete t[e].ch_variables, t[e].cut_variables && delete t[e].cut_variables, !0)
		}, this.callPetitAction = function (e) {
			return !(!e || "function" != typeof t[e].callaction) && (t[e].callaction(t[e]), !0)
		}, this.setWidth = function (t) {
			return !!t && (i = t, !0)
		}, this.getWidth = function () {
			return i
		}, this.doAction = function (e, i, n) {
			if (!e || !t[e] || !t[e].api) return !1;
			i && t[e].api.setVariables("", i), t[e].api.callActions("", n)
		}, this.getBodyType = function (e) {
			return t[e].body_type
		}, this.getAttribute = function (e) {
			return void 0 != t[e] && t[e].attribute
		}, this.getOption = function (t) {
			var e = {
				enableButton: !1,
				partialDraw: window.getPexPartialDraw(),
				delayEval: !1,
				transparent: !0,
				touchEvent: !1,
				operation: {
					lighter_tgt: "lighter"
				},
				width: this.getWidth()
			};
			return t && (e.replace = t), e
		}, this.getVariables = function (t) {
			return void 0 != t && {
				small_character_flg: 2 == t.body_type ? 1 : 0,
				big_character_flg: 4 == t.body_type ? 1 : 0,
				cheek_type: 3 == t.body_type ? 2 : 1,
				chara_num: this.getCharacterLength(),
				chara_order: t.position
			}
		}, this.getImageUrlList = function (e) {
			return void 0 != t[e] && t[e].image_url_list
		}, this.setImageUrlList = function (e, i) {
			if (void 0 == t[e] || void 0 == i) return !1;
			t[e].image_url_list = i
		}
	}

	function e(t, e) {
		this.pex = !1, this.api = !1, this.parent = e, this.position = t, this.shortpants = !1, this.callaction = null
	}
	var i = window.petitManager || new t,
		n = window.Pex;
	t.prototype.init = function (t) {
		if (!this.elementsInitialize()) return void console.error("don't have element");
		var i = [];
		if (this.deleteQue.length) {
			for (var n in this.deleteQue) this.deleteCharacter(this.deleteQue[n]);
			this.deleteQue.splice(0, this.deleteQue.length)
		}
		for (var n in t) void 0 == t[n].parent && $.extend(t[n], new e(n, this)), "string" == typeof t[n].swf && -1 == $.inArray(t[n].swf, this.swf_url_list) && (this.swf_url_list.push(t[n].swf), i.push(t[n].swf), this.ready_swf_list[t[n].swf] = !1);
		if (0 == i.length) return void this.initReady(t);
		var r = [];
		for (var n in i) {
			var a = $.Deferred();
			r.push(a.promise()), this.preLoadSwf(i[n], n, a)
		}
		var s = this;
		$.when.apply($, r).then(function () {
			s.initReady(t)
		})
	}, t.prototype.isUsePreload = function (t) {
		if (!this.elementsInitialize()) return void console.error("don't have element");
		var e = !1;
		for (var i in t)
			if ("string" == typeof t[i].swf && !this.ready_swf_list[t[i].swf]) {
				e = !0;
				break
			}
		e ? this.init(t) : this.initReady(t)
	}, t.prototype.preLoadSwf = function (t, e, i) {
		var r = this,
			a = "preload_" + e,
			s = document.createElement("div");
		$(s).attr("id", a).addClass("animation").css("display", "none"), this.setPrefetch(), this.prefetch.appendChild(s);
		var o = new n(t, a, null),
			h = o.getAPI();
		h.ready(function () {
			h.destroy(), i.resolve(), r.ready_swf_list[t] = !0
		})
	}, t.prototype.initReady = function (t) {
		this.pexInitialize(), this.clothMerge(t)
	}, t.prototype.elementsInitialize = function () {
		return this.$el || (this.$el = $(this.el)), !!this.$el.length && (this.$el.empty(), !0)
	}, t.prototype.setAspect = function () {
		var t = this.$el.children(".animation");
		this.$el.css({
			width: .5 * parseInt(t.css("width")),
			height: .5 * parseInt(t.css("height"))
		})
	}, t.prototype.clothMerge = function (t) {
		var e = new Object;
		for (var i in t) $.extend(e, t[i].image_url_list);
		this.loadClothData(e, t)
	}, t.prototype.loadClothData = function (t, e) {
		var i = this,
			n = [];
		for (var r in t) {
			var a = $.Deferred();
			n.push(a.promise()), void 0 === this.cloth_data[r] ? void 0 !== window[r] ? this.imageAlready(r, window[r], a) : this.loadImageJs(t[r], r, a) : a.resolve()
		}
		$.when.apply($, n).then(function () {
			$(i.prefetch).empty(), i.ready(e)
		})
	}, t.prototype.loadImageJs = function (t, e, i) {
		var n = this,
			r = document.createElement("script");
		r.onload = function () {
			n.imageAlready(e, window[e], i)
		}, r.src = t, document.getElementsByTagName("head")[0].appendChild(r)
	}, t.prototype.imageAlready = function (t, e, i) {
		var n = [];
		for (var r in e) {
			var a = $.Deferred();
			n.push(a), this.cloth_data[t] = new Array, this.imageToReplace(t, e[r], r, a)
		}
		$.when.apply($, n).then(function () {
			i.resolve()
		})
	}, t.prototype.imageToReplace = function (t, e, i, n) {
		var r = new Image,
			a = this;
		r.onload = function () {
			a.cloth_data[t].push({
				name: i,
				img: r
			}), n.resolve()
		}, r.src = e, this.setPrefetch(), this.prefetch.appendChild(r)
	}, t.prototype.setPrefetch = function () {
		if (!this.prefetch) {
			var t = document.getElementById("prefetch");
			t || (t = document.createElement("div"), t.id = "prefetch", document.getElementsByTagName("head")[0].appendChild(t)), this.prefetch = t
		}
	}, t.prototype.ready = function (t) {
		var e = this,
			i = [];
		for (var n in t)
			if (void 0 != t[n].swf) {
				var r = $.Deferred();
				t[n].init(r), i.push(r.promise())
			}
		$.when.apply($, i).then(function () {
			"function" == typeof e.loaded_action && e.loaded_action(t)
		})
	}, e.prototype.isShortpants = function (t) {
		var e = !1,
			i = this.parent.cloth_data[t];
		if (i)
			for (var n in i) "replace_leg_L_front" == i[n].name && (e = !0);
		this.shortpants = e
	}, e.prototype.init = function (t) {
		this.deffered = t;
		for (var e in this.image_url_list) e.indexOf("costume") > -1 && this.isShortpants(e);
		var i = new Array;
		for (var e in this.image_url_list)
			for (var n in this.parent.cloth_data[e]) {
				if (e.indexOf("costume") > -1) {
					if ((2 == this.breast_size || 3 == this.breast_size) && "replace_breast_L" == this.parent.cloth_data[e][n].name) continue;
					if ((1 == this.breast_size || 3 == this.breast_size) && "replace_breast_S" == this.parent.cloth_data[e][n].name) continue
				}
				if (e.indexOf("leg") > -1)
					if (this.shortpants) {
						if ("replace_item_foot_L_back" == this.parent.cloth_data[e][n].name) continue
					} else if ("replace_item_foot_L_front" == this.parent.cloth_data[e][n].name) continue;
				i.push(this.parent.cloth_data[e][n])
			}
		this.setOption(i, t)
	}, e.prototype.setOption = function (t, e) {
		this.pexRun(this.parent.getOption(t, this.scene_type), e)
	}, e.prototype.pexRun = function (t, e) {
		var i = this,
			r = "animation_" + this.position,
			a = document.createElement("div");
		$(a).attr("id", r).addClass("animation"), this.parent.$el.append(a), this.pex = new n(this.swf, r, t), this.api = this.pex.getAPI(), this.api.ready(function () {
			var t = i.parent.getVariables(i);
			t && i.api.setVariables("/", t), "function" == typeof i.callaction && i.callaction(i), e.resolve()
		})
	}, e.prototype.delPex = function () {
		this.api && (this.api.destroy(), this.api = !1, this.pex = !1)
	}, window.petitManager = i
}();
